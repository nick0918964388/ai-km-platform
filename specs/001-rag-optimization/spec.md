# Feature Specification: RAG 系統優化

**Feature Branch**: `001-rag-optimization`
**Created**: 2026-01-31
**Status**: Draft
**Input**: 下一階段優化需求 - Reranker 整合、持久化向量資料庫、常見問題快取、前端上傳進度

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 搜尋結果精確度提升 (Priority: P1)

維修人員使用專業術語（如「轉向架軸箱」、「EMU800 齒輪箱」）搜尋時，系統能夠優先返回最相關的文件段落，而非僅依賴關鍵字匹配的結果。透過重排序機制，確保專業術語搜尋的準確度顯著提升。

**Why this priority**: 搜尋準確度是知識管理系統的核心價值，直接影響維修人員的工作效率。若搜尋結果不精確，用戶將失去對系統的信任。

**Independent Test**: 可透過輸入專業術語查詢，驗證返回結果的相關性排序是否正確，並與未使用重排序前的結果比較。

**Acceptance Scenarios**:

1. **Given** 維修人員輸入專業術語「轉向架軸箱潤滑」，**When** 系統執行搜尋，**Then** 返回結果中前 5 筆應包含與轉向架軸箱維護相關的文件段落
2. **Given** 混合搜尋返回 20 筆初步結果，**When** 系統執行重排序，**Then** 結果應依相關性重新排列，專業術語精確匹配的段落排序優先
3. **Given** 搜尋結果包含多個相似段落，**When** 重排序完成，**Then** 最相關的段落應排在最前，且整體搜尋回應時間維持在 2 秒內

---

### User Story 2 - 資料持久化與可靠性 (Priority: P2)

系統管理員需要確保向量資料庫的資料在系統重啟後仍然保留，並能夠執行資料備份與恢復操作，以防止資料遺失。

**Why this priority**: 資料持久化是系統可靠性的基礎，確保已索引的文件資料不會因系統重啟而遺失，減少重複索引的時間成本。

**Independent Test**: 可透過重啟服務後驗證向量資料是否仍然存在，以及測試備份檔案的恢復流程。

**Acceptance Scenarios**:

1. **Given** 系統已索引 100 份文件，**When** 服務重新啟動，**Then** 所有已索引的文件資料應自動載入且可搜尋
2. **Given** 管理員觸發資料備份，**When** 備份完成，**Then** 系統應產生備份檔案並顯示備份成功訊息
3. **Given** 需要恢復資料，**When** 管理員執行恢復操作，**Then** 系統應從備份檔案完整恢復所有向量資料

---

### User Story 3 - 熱門查詢快速回應 (Priority: P3)

頻繁查詢相同問題的使用者（如「EMU800 保養週期」）能夠獲得即時回應，系統自動快取熱門查詢結果，減少重複運算。

**Why this priority**: 快取機制能顯著提升常見問題的回應速度，改善使用者體驗，同時降低系統運算負擔。

**Independent Test**: 可透過重複查詢相同問題，驗證第二次查詢的回應時間是否顯著縮短。

**Acceptance Scenarios**:

1. **Given** 使用者查詢「EMU800 保養週期」，**When** 該查詢為首次執行，**Then** 系統執行完整搜尋並快取結果
2. **Given** 相同查詢已被快取，**When** 另一使用者查詢相同問題，**Then** 系統應直接返回快取結果，回應時間小於 100 毫秒
3. **Given** 快取資料已超過設定的存活時間，**When** 使用者再次查詢，**Then** 系統應重新執行搜尋並更新快取

---

### User Story 4 - 文件上傳進度追蹤 (Priority: P4)

上傳大型文件的使用者需要即時了解處理進度，包括文件解析、分塊、向量化等步驟的完成百分比，避免長時間等待時的焦慮。

**Why this priority**: 即時進度回饋改善使用者體驗，讓使用者了解系統正在處理中，避免重複上傳或提前離開頁面。

**Independent Test**: 可透過上傳大型文件，驗證前端是否即時顯示處理進度百分比。

**Acceptance Scenarios**:

1. **Given** 使用者上傳一份 PDF 文件，**When** 系統開始處理，**Then** 前端應即時顯示處理狀態（如「解析中」、「分塊中」、「向量化中」）
2. **Given** 文件處理進行中，**When** 進度更新，**Then** 前端應顯示完成百分比且更新間隔不超過 2 秒
3. **Given** 文件處理完成，**When** 所有步驟結束，**Then** 前端應顯示完成訊息並允許使用者立即搜尋該文件內容

---

### Edge Cases

- 當 Reranker 服務不可用時，系統應 fallback 至原有排序邏輯並記錄警告
- 當快取服務不可用時，系統應直接執行搜尋而不中斷服務
- 當向量資料庫備份過程中有新文件上傳時，系統應確保資料一致性
- 當使用者在上傳過程中關閉瀏覽器再重開時，應能查看未完成的上傳任務狀態
- 當快取 TTL 過期恰好在查詢進行中時，系統應避免快取穿透問題

## Requirements *(mandatory)*

### Functional Requirements

**Reranker 整合**
- **FR-001**: 系統 MUST 在混合搜尋（Hybrid Search）完成後執行結果重排序
- **FR-002**: 系統 MUST 支援設定重排序的候選結果數量上限
- **FR-003**: 系統 MUST 在重排序服務不可用時自動降級至原有排序

**持久化向量資料庫**
- **FR-004**: 系統 MUST 將向量資料持久化儲存，確保重啟後資料保留
- **FR-005**: 系統 MUST 提供手動觸發資料備份的功能
- **FR-006**: 系統 MUST 支援從備份檔案恢復資料
- **FR-007**: 系統 MUST 記錄備份時間與檔案位置

**常見問題快取**
- **FR-008**: 系統 MUST 快取查詢結果，避免重複運算
- **FR-009**: 系統 MUST 支援設定快取的存活時間（TTL）
- **FR-010**: 系統 MUST 在來源文件更新時自動清除相關快取
- **FR-011**: 系統 MUST 在快取服務不可用時正常執行搜尋

**前端上傳進度**
- **FR-012**: 系統 MUST 即時推送文件處理進度至前端
- **FR-013**: 系統 MUST 顯示處理步驟名稱與完成百分比
- **FR-014**: 系統 MUST 在處理完成或失敗時通知前端
- **FR-015**: 系統 MUST 支援使用者查看進行中的處理任務列表

### Key Entities

- **CachedQuery**: 快取的查詢記錄，包含查詢文字、結果、建立時間、過期時間
- **BackupRecord**: 備份記錄，包含備份時間、檔案路徑、資料量、狀態
- **ProcessingTask**: 文件處理任務，包含任務 ID、文件資訊、目前步驟、進度百分比、狀態

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 專業術語搜尋的相關性評分（NDCG@10）較優化前提升 20% 以上
- **SC-002**: 系統重啟後所有已索引文件資料 100% 可用
- **SC-003**: 快取命中時查詢回應時間小於 100 毫秒（p95）
- **SC-004**: 整體搜尋回應時間維持在 2 秒以內（p95），符合 Constitution 效能要求
- **SC-005**: 文件處理進度更新延遲小於 2 秒
- **SC-006**: 使用者對搜尋結果滿意度提升至 85% 以上

## Assumptions

- 系統已有運作中的 Hybrid Search 功能
- 前端已有文件上傳介面
- 系統有足夠的儲存空間存放向量資料與備份檔案
- 快取 TTL 預設為 1 小時，可由管理員調整
- 備份檔案預設儲存於本地檔案系統，後續可擴展至雲端儲存
