# Feature Specification: 結構化資料查詢

**Feature Branch**: `003-structured-data-query`
**Created**: 2026-02-01
**Status**: Draft
**Input**: 為 AIKM 車輛維修知識管理平台新增結構化資料查詢能力，讓使用者可以透過自然語言查詢結構化的維修資料

## 概述

本功能為現有 AIKM 知識管理系統擴展結構化資料查詢能力。使用者可透過自然語言提問，系統自動識別查詢意圖（知識庫 vs 結構化資料），並將自然語言轉換為資料庫查詢，返回格式化的結果。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自然語言查詢車輛故障歷程 (Priority: P1)

維修技師在對話介面輸入「查詢 EMU801 的故障歷程」，系統自動識別這是結構化資料查詢請求，將其轉換為資料庫查詢，並以資料卡片形式在對話中顯示該車輛的故障紀錄清單。

**Why this priority**: 故障歷程查詢是維修技師最頻繁使用的功能，直接影響故障診斷效率。

**Independent Test**: 可透過輸入車輛編號查詢故障歷程並驗證返回資料正確性來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者已登入系統，**When** 輸入「查詢 EMU801 故障歷程」，**Then** 系統顯示 EMU801 的故障紀錄清單，包含故障日期、故障類型、處理狀態
2. **Given** 使用者查詢不存在的車輛，**When** 輸入「查詢 EMU999 故障歷程」，**Then** 系統顯示「查無此車輛資料」的友善提示
3. **Given** 使用者查詢無故障紀錄的車輛，**When** 輸入查詢，**Then** 系統顯示「該車輛目前無故障紀錄」

---

### User Story 2 - AI 意圖識別與路由 (Priority: P1)

使用者在同一對話介面中可能提出知識型問題（如「如何更換煞車來令」）或資料型問題（如「EMU801 上次保養日期」）。系統自動判斷查詢類型並路由至對應的處理引擎。

**Why this priority**: 統一的對話介面是提升使用者體驗的核心，避免使用者需要切換不同系統。

**Independent Test**: 可透過輸入不同類型問句並驗證系統正確路由來測試。

**Acceptance Scenarios**:

1. **Given** 使用者輸入知識型問題，**When** 提問「煞車系統的維修注意事項」，**Then** 系統從知識庫返回相關維修文件
2. **Given** 使用者輸入資料型問題，**When** 提問「EMU802 的維修成本統計」，**Then** 系統查詢結構化資料庫並返回成本資料
3. **Given** 使用者輸入混合型問題，**When** 提問「EMU801 為何經常出現轉向架故障」，**Then** 系統同時查詢故障歷程資料與相關維修知識

---

### User Story 3 - 資料瀏覽與篩選 (Priority: P2)

使用者可透過側邊面板瀏覽結構化資料，使用篩選條件縮小範圍，並將結果匯出為報表。

**Why this priority**: 提供進階資料探索能力，滿足需要深入分析資料的使用者需求。

**Independent Test**: 可透過開啟側邊面板、套用篩選條件、驗證結果正確性來測試。

**Acceptance Scenarios**:

1. **Given** 使用者開啟資料面板，**When** 選擇「故障歷程」資料表，**Then** 顯示可用的篩選欄位（日期範圍、車輛編號、故障類型等）
2. **Given** 使用者套用篩選條件，**When** 設定「2025年」+「轉向架故障」，**Then** 僅顯示符合條件的紀錄
3. **Given** 使用者選擇匯出，**When** 點擊匯出按鈕，**Then** 系統產生 CSV/Excel 檔案供下載

---

### User Story 4 - 關鍵指標儀表板 (Priority: P3)

管理者可查看車輛維修相關的關鍵統計指標儀表板，包含故障率趨勢、維修成本分布、庫存警示等視覺化圖表。

**Why this priority**: 統計儀表板提供宏觀洞察，但非日常維修作業必需。

**Independent Test**: 可透過載入儀表板頁面並驗證圖表正確顯示來測試。

**Acceptance Scenarios**:

1. **Given** 管理者進入儀表板頁面，**When** 頁面載入完成，**Then** 顯示故障趨勢圖、維修成本統計、庫存狀態等圖表
2. **Given** 圖表已顯示，**When** 管理者點擊特定數據點，**Then** 顯示該數據的詳細明細

---

### Edge Cases

- 當查詢語句模糊無法判斷意圖時，系統應請求使用者澄清
- 當資料庫查詢超時時，系統應顯示重試選項並記錄問題
- 當查詢結果過多（超過 100 筆）時，系統應分頁顯示並提示使用者縮小查詢範圍
- 當使用者無權限查看特定資料時，系統應顯示權限不足提示

## Requirements *(mandatory)*

### Functional Requirements

**意圖識別與路由**
- **FR-001**: 系統 MUST 自動識別使用者查詢屬於「知識庫查詢」或「結構化資料查詢」
- **FR-002**: 系統 MUST 支援混合型查詢，同時從知識庫和結構化資料庫獲取資訊

**自然語言轉查詢**
- **FR-003**: 系統 MUST 將自然語言查詢轉換為資料庫查詢語句
- **FR-004**: 系統 MUST 支援中文自然語言輸入
- **FR-005**: 系統 MUST 在無法理解查詢時，向使用者請求澄清

**資料存取**
- **FR-006**: 系統 MUST 支援查詢以下資料表：
  - 車輛基本資料 (vehicles)
  - 車輛故障歷程 (fault_records)
  - 車輛檢修歷程 (maintenance_records)
  - 使用歷程 (usage_records)
  - 保養檢修用料歷程 (parts_used)
  - 車輛維修成本 (cost_records)
  - 庫存查詢 (parts_inventory)
- **FR-007**: 系統 MUST 根據使用者角色控制資料存取權限

**結果呈現**
- **FR-008**: 系統 MUST 以資料卡片形式在對話中嵌入查詢結果
- **FR-009**: 系統 MUST 提供側邊面板供進階資料瀏覽與篩選
- **FR-010**: 系統 MUST 支援將查詢結果匯出為 CSV 或 Excel 格式
- **FR-011**: 系統 MUST 對大量結果（超過 100 筆）進行分頁處理

**儀表板**
- **FR-012**: 系統 MUST 提供關鍵指標統計儀表板
- **FR-013**: 系統 MUST 支援儀表板數據的鑽取（drill-down）功能

### Key Entities

- **Vehicle (車輛)**: 車輛編號、車型、製造年份、目前狀態、所屬機務段
- **FaultRecord (故障紀錄)**: 故障編號、車輛、故障日期、故障類型、嚴重程度、處理狀態、描述
- **MaintenanceRecord (檢修紀錄)**: 檢修編號、車輛、檢修日期、檢修類型、執行技師、完成狀態
- **UsageRecord (使用紀錄)**: 紀錄編號、車輛、日期、運行里程、運行時數
- **PartsUsed (用料紀錄)**: 紀錄編號、檢修紀錄關聯、零件編號、數量、單價
- **CostRecord (成本紀錄)**: 紀錄編號、車輛、期間、工時成本、材料成本、總成本
- **PartsInventory (零件庫存)**: 零件編號、零件名稱、現有庫存、安全庫存、單位、存放位置

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90% 以上的自然語言查詢能正確識別意圖並路由至對應處理引擎
- **SC-002**: 使用者能在 10 秒內獲得結構化資料查詢結果
- **SC-003**: 80% 以上的使用者首次使用即能成功完成資料查詢
- **SC-004**: 資料匯出功能支援單次匯出最多 10,000 筆紀錄
- **SC-005**: 儀表板頁面在 3 秒內完成載入並顯示所有圖表
- **SC-006**: 減少維修技師查詢歷史資料所需時間 60% 以上（相較於現有手動查詢方式）

## Assumptions

- 結構化資料將儲存於 PostgreSQL 資料庫（新增）
- 現有 AIKM 系統已具備使用者認證與角色管理機制
- 車輛資料已有標準化的編號規則（如 EMU8xx 系列）
- 使用者主要使用繁體中文進行查詢
- 系統將與現有的對話介面整合，無需另建獨立介面

## Dependencies

- 現有 AIKM 對話介面（用於嵌入結構化資料卡片）
- 現有使用者認證與權限管理系統
- 需建立結構化資料的初始資料來源與匯入機制

## Out of Scope

- 結構化資料的維護介面（新增/編輯/刪除資料）
- 資料自動同步機制（從外部系統匯入）
- 即時警報通知功能
- 行動裝置專用介面
