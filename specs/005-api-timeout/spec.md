# Feature Specification: API Timeout and Resilience

**Feature Branch**: `005-api-timeout`
**Created**: 2026-02-02
**Status**: Draft
**Input**: User description: "Implement comprehensive timeout functionality for all API calls in the AIKM frontend: Default timeout of 30 seconds for regular API calls, Extended timeout of 120 seconds for file upload operations, Timeout of 60 seconds for chat/streaming requests, AbortController integration for request cancellation, User-friendly error messages when timeout occurs, Optional retry mechanism with exponential backoff, Loading state management during retries"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Protected Regular Operations (Priority: P1)

維修人員在車站機房查詢維修紀錄時，若網路回應緩慢，系統會在 30 秒後顯示清楚的超時訊息，並提供重試選項，讓使用者能快速恢復操作，而不是無限期等待。

**Why this priority**: 這是最基礎也最常見的使用場景。一般 API 操作（查詢、更新、刪除）佔系統互動的 80% 以上，必須優先保護這些操作不會因網路問題卡住使用者。

**Independent Test**: 可透過模擬慢速 API 端點（延遲 35 秒回應）測試。當使用者執行一般查詢操作時，應在 30 秒後看到「連線逾時，請檢查網路狀態」訊息，並有「重試」按鈕。點擊重試後，系統應重新發送請求並顯示載入狀態。

**Acceptance Scenarios**:

1. **Given** 使用者正在查詢文件列表，**When** API 回應時間超過 30 秒，**Then** 系統顯示「連線逾時，請稍後再試或檢查網路連線」的中文友善訊息
2. **Given** 使用者看到超時錯誤訊息，**When** 使用者點擊「重試」按鈕，**Then** 系統重新發送請求，並顯示載入指示器
3. **Given** 使用者執行更新操作且 API 回應緩慢，**When** 超過 30 秒仍未完成，**Then** 系統取消請求並顯示錯誤訊息，不會造成重複更新
4. **Given** 使用者在載入狀態時，**When** 使用者導航到其他頁面，**Then** 系統自動取消進行中的請求，不會影響新頁面的載入

---

### User Story 2 - Extended Timeout for File Uploads (Priority: P2)

維修人員上傳大型維修報告 PDF 或設備照片時，系統允許更長的上傳時間（120 秒），避免因檔案大小或網路速度導致誤判超時，並在上傳過程中顯示進度提示。

**Why this priority**: 檔案上傳是特殊操作，需要更長的超時設定。雖然不如一般操作頻繁，但對使用者體驗影響很大，失敗的上傳會導致使用者重新準備檔案並重試。

**Independent Test**: 可透過上傳 50MB 測試檔案到模擬慢速端點（上傳速度限制為 1MB/s）測試。系統應允許完整上傳過程（約 50 秒），不應在 30 秒時超時。若上傳超過 120 秒，則顯示超時錯誤。

**Acceptance Scenarios**:

1. **Given** 使用者選擇上傳 30MB 的維修報告 PDF，**When** 上傳時間為 90 秒，**Then** 系統成功完成上傳，不會觸發超時錯誤
2. **Given** 使用者上傳檔案時網路異常緩慢，**When** 超過 120 秒仍未完成，**Then** 系統顯示「檔案上傳逾時，請檢查檔案大小或網路速度」訊息
3. **Given** 使用者正在上傳檔案，**When** 使用者點擊「取消上傳」按鈕，**Then** 系統立即中止上傳並釋放資源
4. **Given** 使用者上傳失敗，**When** 使用者點擊「重新上傳」，**Then** 系統使用相同的 120 秒超時設定重新嘗試上傳

---

### User Story 3 - Chat and Streaming Resilience (Priority: P3)

維修人員使用 AI 聊天功能查詢技術問題時，系統在 60 秒內等待 AI 回應。若 AI 回應時間過長，系統顯示超時訊息並允許使用者取消或重試，避免使用者誤以為系統卡住。

**Why this priority**: 聊天串流是特殊的長時間操作，需要平衡使用者等待意願與系統穩定性。雖然重要，但相對於一般查詢操作使用頻率較低。

**Independent Test**: 可透過模擬慢速 AI 回應（70 秒才開始串流）測試。使用者發送聊天訊息後，系統應顯示「AI 思考中...」載入狀態。60 秒後應顯示「AI 回應逾時，請重新提問或稍後再試」訊息。

**Acceptance Scenarios**:

1. **Given** 使用者向 AI 提問，**When** AI 回應時間超過 60 秒，**Then** 系統顯示「AI 回應逾時，請嘗試重新提問或簡化問題」訊息
2. **Given** 使用者在等待 AI 回應時，**When** 使用者點擊「停止生成」按鈕，**Then** 系統立即停止等待並取消請求
3. **Given** AI 聊天超時，**When** 使用者點擊「重試」，**Then** 系統使用相同的問題重新發送請求，並重置 60 秒超時計時器
4. **Given** 使用者正在接收串流回應，**When** 串流中斷超過 10 秒（連線中斷偵測），**Then** 系統顯示「連線中斷」警告並提供重新連線選項

---

### User Story 4 - Automatic Retry with Backoff (Priority: P4)

當系統偵測到暫時性網路錯誤（如 503 服務暫時無法使用、網路斷線），系統自動重試最多 3 次（間隔 1 秒、2 秒、4 秒），並在重試過程中顯示「正在重試... (第 2/3 次)」狀態，讓使用者了解系統正在恢復。

**Why this priority**: 自動重試提升系統韌性，但不是核心功能。可在基礎超時機制穩定後再實作，作為體驗優化。

**Independent Test**: 可透過模擬不穩定 API（前兩次回應 503，第三次成功）測試。使用者執行查詢操作時，系統應自動重試，無需使用者手動點擊重試按鈕，並在最終成功時顯示正常結果。

**Acceptance Scenarios**:

1. **Given** 使用者執行查詢操作，**When** API 回應 503 錯誤，**Then** 系統自動重試，顯示「連線不穩定，正在重試... (第 1/3 次)」
2. **Given** 系統正在自動重試，**When** 第二次重試成功，**Then** 系統顯示正常結果，不再繼續重試
3. **Given** 系統已重試 3 次，**When** 全部失敗，**Then** 系統停止自動重試，顯示錯誤訊息並提供手動「重試」按鈕
4. **Given** 系統正在自動重試，**When** 使用者點擊「取消」按鈕，**Then** 系統立即停止重試流程
5. **Given** 使用者執行新增或刪除操作（非冪等），**When** API 回應錯誤，**Then** 系統不自動重試，僅顯示錯誤訊息與手動「重試」按鈕

---

### Edge Cases

- **多個請求同時超時**: 當使用者同時觸發多個 API 操作（如批次更新），若多個請求同時超時，系統應分別顯示錯誤狀態，不應合併為單一錯誤訊息，讓使用者能識別哪些操作失敗
- **超時發生於頁面切換時**: 若使用者在請求進行中切換頁面，系統應自動取消前一頁面的請求，避免背景請求累積消耗資源
- **重試過程中網路恢復**: 若系統正在重試（如第 2 次重試延遲中），此時網路恢復，系統應立即執行下一次重試，不需等完整的延遲時間
- **伺服器回應極慢但未完全超時**: 若 API 回應時間接近但未超過超時閾值（如 28 秒），系統應正常處理回應，不應誤判為超時
- **串流回應部分成功**: 對於聊天串流，若 AI 已開始回應（串流已開始），中途發生超時（如串流暫停超過 10 秒），系統應保留已接收的部分回應，並提示使用者「回應未完成，是否繼續？」

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 為所有 API 請求設定超時機制，防止無限期等待
- **FR-002**: 系統 MUST 為一般 API 操作（查詢、更新、刪除）設定 30 秒超時
- **FR-003**: 系統 MUST 為檔案上傳操作設定 120 秒超時
- **FR-004**: 系統 MUST 為聊天與串流請求設定 60 秒超時
- **FR-005**: 系統 MUST 在所有請求中整合取消機制，允許使用者或系統主動中止請求
- **FR-006**: 系統 MUST 在超時發生時顯示繁體中文友善錯誤訊息，避免技術術語
- **FR-007**: 系統 MUST 區分不同類型的錯誤（網路超時、伺服器錯誤 5xx、認證失敗 401、客戶端錯誤 4xx），並顯示對應的錯誤訊息
- **FR-008**: 系統 MUST 在錯誤訊息中提供操作建議（如「請檢查網路連線」、「請稍後再試」）
- **FR-009**: 系統 MUST 為所有超時與重試事件記錄日誌，包含請求類型、超時時間、重試次數
- **FR-010**: 系統 SHOULD 對暫時性錯誤（5xx、網路超時）實作自動重試，最多 3 次
- **FR-011**: 系統 MUST 使用指數退避策略進行重試（間隔 1 秒、2 秒、4 秒）
- **FR-012**: 系統 MUST 僅對冪等操作（查詢、取得資料）啟用自動重試
- **FR-013**: 系統 MUST 對非冪等操作（新增、刪除、更新）提供手動重試按鈕，不自動重試
- **FR-014**: 系統 MUST 在重試過程中顯示載入狀態與目前嘗試次數（如「正在重試... 第 2/3 次」）
- **FR-015**: 系統 MUST 在頁面切換或元件卸載時自動取消進行中的請求
- **FR-016**: 系統 MUST 在長時間操作（超過 3 秒）時顯示載入指示器
- **FR-017**: 系統 MUST 允許使用者在任何時候取消進行中的請求（透過「取消」或「停止」按鈕）
- **FR-018**: 系統 MUST 在取消請求後立即釋放相關資源，停止所有後續處理

### Key Entities

- **API Request Configuration**: 定義每個請求的超時設定、重試策略、取消控制器，包含屬性如請求類型（一般/上傳/串流）、超時閾值（秒）、是否可重試、重試次數上限
- **Error Context**: 記錄錯誤發生時的上下文資訊，包含錯誤類型（超時/伺服器錯誤/網路錯誤）、使用者友善訊息、建議操作、是否可重試
- **Retry State**: 追蹤重試狀態，包含目前嘗試次數、下次重試時間、是否由使用者手動觸發

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者在網路緩慢情境下（API 回應時間 > 30 秒），能在 30 秒內看到明確的超時訊息，而非無限期等待
- **SC-002**: 使用者能在 2 秒內取消任何進行中的請求，系統立即停止處理並釋放資源
- **SC-003**: 檔案上傳操作在正常網路速度下（1-3 MB/s），能完整上傳最多 50MB 的檔案而不觸發超時錯誤
- **SC-004**: 對於暫時性網路錯誤（如 503），系統自動重試成功率達 80% 以上（無需使用者手動重試）
- **SC-005**: 所有超時與重試事件均記錄日誌，便於診斷網路問題與系統效能
- **SC-006**: 使用者看到的錯誤訊息為繁體中文，無技術術語（如 "ERR_CONNECTION_TIMEOUT"），90% 使用者能理解錯誤含義與建議操作
- **SC-007**: 重試過程中，使用者能清楚看到系統正在恢復（顯示「正在重試... 第 X/3 次」），不會誤以為系統卡住
- **SC-008**: 頁面切換時，所有前一頁面的進行中請求自動取消，不會累積背景請求影響效能

## Assumptions

- 假設後端 API 支援常見的 HTTP 狀態碼（4xx、5xx），並能區分暫時性錯誤（503）與永久性錯誤（404、401）
- 假設使用者環境可能面臨不穩定網路（車站機房、移動環境），需要較強的容錯能力
- 假設大部分 API 操作（查詢、列表）為冪等操作，可安全重試
- 假設檔案上傳大小上限為 50MB，且網路速度通常在 1-3 MB/s 範圍
- 假設 AI 聊天回應時間通常在 10-30 秒內，60 秒已足夠涵蓋正常情境
- 假設前端框架（Next.js）支援 AbortController 標準 API 進行請求取消
